pico-8 cartridge // http://www.pico-8.com
version 41
__lua__

#include vec2d.lua
#include body.lua
#include util.lua

local world_scale = 8
local world_size = 128 / world_scale
local world_tl = makevec2d(-world_size, -world_size) / 2
local world_br = makevec2d( world_size,  world_size) / 2

function screen_space(pos)
    return pos * world_scale
end

-- physics entities
local static_bodies = {}
local bodies = {}

-- objects with references to physics bodies
local projectiles = {}
local players = {}

local projectile_mass = 0.15
local projectile_radius = 0.2
function add_projectile(pos, vel)
    local p = make_body(pos, vel, projectile_mass, projectile_radius, PROJECTILE)
    add(bodies, p)
    add(projectiles, {
        body = p
    })
end

function projectile_should_die(proj)
    local p = proj.body.pos
    return p.x < world_tl.x - world_size / 2 or p.x > world_br.x + world_size / 2 or
           p.y < world_tl.y - world_size / 2 or p.y > world_br.y + world_size / 2
end

function remove_dead_projectiles()
   for _, proj in ipairs(projectiles) do
        if projectile_should_die(proj) then 
            del(bodies, proj.body)
            del(projectiles, proj)
        end
   end
end

local player_mass = 4
local player_radius = 0.32
function add_player(pos, vel, playeridx)
    local body = make_body(pos, vel, player_mass, player_radius, PLANET)
    add(players, {
        body = body,
        index = playeridx,
        controldir = makevec2d(0, 0)
    })
    add(bodies, body)
end

local recoil_strength = 1200
local 
function shoot_projectile(player, shootdir)
    if (shootdir.x == 0 and shootdir.y == 0) return

    local body = player.body
    body:add_force(shootdir * (-1200))
    -- offset projectile position by player radius in the shooting direction
    local proj_pos = body.pos + shootdir:unit() * (body.radius * 2.01) 
    add_projectile(proj_pos, body.vel + shootdir * 10)
end

function update_player_controls()
    for _, player in ipairs(players) do
        player.controldir = gamepad_dir(player.index)
        if btnp(controls.x, player.index) then
            shoot_projectile(player, player.controldir)
        end
    end
end

add_player(
    makevec2d(-4, -4), 
    makevec2d(-4, 4), 
    0
)

add(static_bodies, make_body(
    makevec2d(0, 0), 
    makevec2d(0, 0),
    16, 0.8, SUN))

local dt = 1 / 60
function update_bodies()
    -- dynamic bodies attract to static bodies and each other
    for _, body in ipairs(bodies) do 
        for _, static_body in ipairs(static_bodies) do
            body:attract_to(static_body)
        end

        for _, other in ipairs(bodies) do
            if body != other then
                body:attract_to(other)
            end
        end
    end

    for _, body in ipairs(bodies) do
        body:update(dt)
    end
end

function _init()
    camera(-64, -64)
end

function _update60()
    update_player_controls()
    remove_dead_projectiles()
    update_bodies()
end

---draw---

function draw_sun(x, y)
    for i = -7, 7 do
        for j = -7, 7 do
            local dist = sqrt(i * i + j * j)
            local angle = atan2(j, i)
            if dist < 5 then
                pset(x + i, y + j, 10)
            elseif dist < 6 then
                pset(x + i, y + j, 9)
            elseif dist < 8 + 1.5 * sin(4.5 * angle + 0.2 * time()) then
                pset(x + i, y + j, 8)
            end
        end
    end
end

function _draw() 
    cls()
    fillp()
    palt(0, true)

    for _, v in ipairs(bodies) do
        local s = screen_space(v.pos)
        local r = screen_space(v.radius)
        if v.type == PLANET then
            spr(1, s.x - 4, s.y - 4)
        elseif v.type == SUN then
            draw_sun(s.x, s.y)
        else
            circ(s.x, s.y, r)
        end
    end

    for _, v in ipairs(static_bodies) do
        local s = screen_space(v.pos)
        local r = screen_space(v.radius)
        if v.type == SUN then
            draw_sun(s.x, s.y)
        else
            circ(s.x, s.y, r)
        end
            
    end
end

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000c7cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070003ccc3c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000033c33300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700003cc33c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000cccc3c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000c77c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002228000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022882200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088822800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000028888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002288000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000006666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000d6d6d600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dd666d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dd6d6600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000dddd6600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000dd66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000099944900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000094499900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000044994400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000044444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
